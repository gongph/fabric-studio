const fs = require('fs')
const path = require('path')
const render = require('json-templater/string')
const endOfLine = require('os').EOL
const ora = require('ora')
const axios = require('axios')
const Url = require('../src/utils/url')

const OUTPUT_PATH =  path.join(__dirname, '../src/styles/fonts.scss')
const INCLUDE_FONT_TEMPLATE = `@font-face {
  font-family: '{{name}}', 'Microsoft YaHei';
  src: url('{{url}}');
  font-weight: normal;
  font-style: normal;
}`
const MAIN_TEMPLATE = `/* Automatically generated by './build/build-fonts.js' */

{{include}}
`
const includeFontTemplate = []
const spinner = ora('Fonts loading...').start()
axios.get(`${Url.baseURL}/api/font-types`).then(response => {
  spinner.succeed('Fonts load succeed.')
  const data = response && response.data
  data.forEach(font => {
    includeFontTemplate.push(render(INCLUDE_FONT_TEMPLATE, {
      name: font.value,
      url: font.name
    }))
  })
  const template = render(MAIN_TEMPLATE, {
    include: includeFontTemplate.join(endOfLine)
  })

  fs.writeFileSync(OUTPUT_PATH, template)
  spinner.succeed('[build fonts] DONE ' + OUTPUT_PATH)
}).catch(err => {
  spinner.fail('Fonts load fail. Reason: ' + err.message)
})
